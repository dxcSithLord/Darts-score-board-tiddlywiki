name: Create Release

on:
  push:
    branches: ['main']
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release Files
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Determine version
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
        else
          # Auto-increment patch version based on latest tag
          LATEST_TAG=$(git tag -l 'v*' --sort=-v:refname | head -n1)
          if [ -z "$LATEST_TAG" ]; then
            VERSION="1.0.0"
          else
            VERSION="${LATEST_TAG#v}"
            IFS='.' read -ra PARTS <<< "$VERSION"
            MAJOR="${PARTS[0]:-1}"
            MINOR="${PARTS[1]:-0}"
            PATCH="${PARTS[2]:-0}"
            PATCH=$((PATCH + 1))
            VERSION="$MAJOR.$MINOR.$PATCH"
          fi
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: Get build date
      id: date
      run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

    - name: Create releases directory
      run: mkdir -p releases

    - name: Create release file with metadata
      run: |
        # Create the release file with version metadata directly (no sed needed)
        VERSION="${{ steps.version.outputs.version }}"
        BUILD_DATE="${{ steps.date.outputs.date }}"
        REPO="${{ github.repository }}"

        # Write header with variables already expanded
        cat > releases/darts-scoreboard-latest.html << EOF
<!DOCTYPE html>
<!--
  Darts Scoreboard - Standalone Release
  Version: ${VERSION}
  Build Date: ${BUILD_DATE}

  This is a standalone HTML file that can be:
  - Downloaded and opened locally via file:// URI
  - Used offline without internet connection
  - All CSS and JavaScript is embedded inline

  GitHub: https://github.com/${REPO}
-->
EOF

        # Append the rest of the HTML file (skip DOCTYPE line)
        tail -n +2 darts-score.html >> releases/darts-scoreboard-latest.html

    - name: Create versioned copy
      run: |
        cp releases/darts-scoreboard-latest.html "releases/darts-scoreboard-v${{ steps.version.outputs.version }}.html"

    - name: Validate release files
      run: |
        npm install -g html-validate
        html-validate releases/darts-scoreboard-latest.html
        echo "âœ“ Release file validation passed"

    - name: Commit release files
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add releases/
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Release v${{ steps.version.outputs.version }} - $(date +'%Y-%m-%d')"
          git push
        fi

    - name: Create GitHub Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          releases/darts-scoreboard-latest.html
          releases/darts-scoreboard-v${{ steps.version.outputs.version }}.html
        generate_release_notes: true
        body: |
          ## Darts Scoreboard v${{ steps.version.outputs.version }}

          ### Downloads
          - **darts-scoreboard-latest.html** - Latest stable release
          - **darts-scoreboard-v${{ steps.version.outputs.version }}.html** - This specific version

          ### Usage
          1. Download the HTML file
          2. Open it in your browser (File > Open or drag & drop)
          3. Works offline - no internet connection required
          4. All features work via file:// URI

          ### Features
          - Multiple game types: 501, 301, 180, and Cricket
          - Track multiple players
          - Automatic score calculation
          - Game history tracking
          - Responsive design

    - name: Create GitHub Release (manual/push)
      if: "!startsWith(github.ref, 'refs/tags/v')"
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: Release v${{ steps.version.outputs.version }}
        files: |
          releases/darts-scoreboard-latest.html
          releases/darts-scoreboard-v${{ steps.version.outputs.version }}.html
        generate_release_notes: true
        draft: true
        body: |
          ## Darts Scoreboard v${{ steps.version.outputs.version }}

          ### Downloads
          - **darts-scoreboard-latest.html** - Latest stable release
          - **darts-scoreboard-v${{ steps.version.outputs.version }}.html** - This specific version

          ### Usage
          1. Download the HTML file
          2. Open it in your browser (File > Open or drag & drop)
          3. Works offline - no internet connection required
          4. All features work via file:// URI
